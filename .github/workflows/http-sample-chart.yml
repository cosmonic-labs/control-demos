---
name: Package and publish HTTP sample Helm chart

on:
  workflow_run:
    workflows: ["Build and publish HTTP sample components"]
    types: 
      - completed

env:
  REGISTRY: ghcr.io
  COMPONENTS: ("http-server" "hono-swagger-ui" "welcome-tour")

jobs:
  publish-chart:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: write
      packages: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Get release info
        id: release
        run: |
          # Get the latest release that triggered the component build
          RELEASE_TAG=$(gh api repos/${{ github.repository }}/releases/latest --jq '.tag_name')
          VERSION=${RELEASE_TAG#v}
          echo "tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "📋 Processing release: $RELEASE_TAG (version: $VERSION)"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate release version
        run: |
          if [[ ! "${{ steps.release.outputs.version }}" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9-]+)?$ ]]; then
            echo "❌ Invalid version format: ${{ steps.release.outputs.version }}"
            exit 1
          fi
          echo "✅ Valid version format: ${{ steps.release.outputs.version }}"

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Login to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Lowercase repository owner
        run: |
          echo "REPO_OWNER_LC=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_ENV

      - name: Verify component images exist
        run: |
          echo "🔍 Verifying published component images..."
          
          COMPONENTS=${{ env.COMPONENTS }}
          for component in "${COMPONENTS[@]}"; do
            IMAGE="${{ env.REGISTRY }}/${{ env.REPO_OWNER_LC }}/components/$component:${{ steps.release.outputs.version }}"
            echo "Checking: $IMAGE"
    
            if docker manifest inspect -v $IMAGE 2>/dev/null; then
              echo "✅ $component: Image exists"
            else
              echo "❌ $component: Image not found or not accessible"
              echo "This may indicate the component build failed or hasn't completed yet"
              exit 1
            fi
          done

      - name: Update chart metadata
        working-directory: ./
        run: |
          # Backup original Chart.yaml
          cp charts/http-sample/Chart.yaml charts/http-sample/Chart.yaml.bak
          
          # Update versions
          sed -i "s/version: .*/version: ${{ steps.release.outputs.version }}/" charts/http-sample/Chart.yaml
          sed -i "s/appVersion: .*/appVersion: \"${{ steps.release.outputs.version }}\"/" charts/http-sample/Chart.yaml
          
          echo "📝 Updated Chart.yaml:"
          diff charts/http-sample/Chart.yaml.bak charts/http-sample/Chart.yaml || true

      - name: Lint Helm chart template
        run: |
          helm lint charts/http-sample/
          echo "✅ Helm chart validation passed"

      - name: Package Helm chart
        working-directory: ./
        run: |
          helm package charts/http-sample --version ${{ steps.release.outputs.version }}
          CHART_FILE="http-sample-${{ steps.release.outputs.version }}.tgz"
          
          if [ ! -f "$CHART_FILE" ]; then
              echo "❌ Chart package not created: $CHART_FILE"
              exit 1
          fi
              echo "✅ Chart packaged: $CHART_FILE"
              echo "CHART_FILE=$CHART_FILE" >> $GITHUB_ENV
          done

      - name: Push Helm chart to OCI registry
        run: |
          CHART_REF="oci://${{ env.REGISTRY }}/${{ env.REPO_OWNER_LC }}/charts/"
          echo "📤 Pushing charts to: $CHART_REF"
          
          helm push http-sample-${{ steps.release.outputs.version }}.tgz $CHART_REF
          echo "✅ Chart http-server-${{ steps.release.outputs.version }} published successfully"

      - name: Update component image tags in values files
        run: |
          echo "🔄 Updating component image tags in values files..."
          
          COMPONENTS=${{ env.COMPONENTS }}
          for component in "${COMPONENTS[@]}"; do
            DEPLOYMENT_FILE="$component/values.yaml"
            OLD_IMAGE=$(grep "image:" "$DEPLOYMENT_FILE" | awk '{print $2}')
            NEW_IMAGE="ghcr.io/${{ env.REPO_OWNER_LC }}/components/$component:${{ steps.release.outputs.version }}"
            # Update the image tag
            sed -i "s|image:.*|image: $NEW_IMAGE|" "$DEPLOYMENT_FILE"
            echo "✅ Updated $component image tag"
          done

      - name: Validate updated values files
        run: |
          echo "🔍 Validating updated values files..."
          
          COMPONENTS=${{ env.COMPONENTS }}
          for component in "${COMPONENTS[@]}"; do
            file="$component/values.yaml"
            if [ -f "$file" ]; then
              if grep -q "ghcr.io/${{ env.REPO_OWNER_LC }}/components/$component:${{ steps.release.outputs.version }}" "$file"; then
                echo "✅ $component: Image tag updated correctly"
              else
                echo "❌ $component: Image tag not updated properly"
                echo "Expected: ghcr.io/${{ env.REPO_OWNER_LC }}/components/$component:${{ steps.release.outputs.version }}"
                echo "Found in $file:"
                grep "image:" "$file" || echo "No image field found"
                exit 1
              fi
            fi
          done

      - name: Create Pull Request for updated image tags
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            Update HTTP sample component image tags to ${{ steps.release.outputs.version }}

            Automated update following release ${{ steps.release.outputs.tag }}

            - Updated http-server image tag
            - Updated hono-swagger-ui image tag
            - Updated welcome-tour image tag
            - Updated http-sample chart version to ${{ steps.release.outputs.version }}
          title: "🚀 Update HTTP sample image tags to ${{ steps.release.outputs.version }}"
          body: |
            ## 📦 Automated Release Update

            This PR updates component image tags and chart version following the successful
            publication of release **${{ steps.release.outputs.tag }}**.

            ### Changes Made
            - 🔄 **HTTP Server**: Updated to `${{ steps.release.outputs.version }}`
            - 🔄 **Hono Swagger UI**: Updated to `${{ steps.release.outputs.version }}`
            - 🔄 **Welcome Tour**: Updated to `${{ steps.release.outputs.version }}`
            - 📦 **Chart Version**: Updated to `${{ steps.release.outputs.version }}`

            ### Published Artifacts
            - 🎯 **Components**: `ghcr.io/${{ env.REPO_OWNER_LC }}/components/*:${{ steps.release.outputs.version }}`
            - ⚙️ **Chart**: `oci://ghcr.io/${{ env.REPO_OWNER_LC }}/charts/http-sample:${{ steps.release.outputs.version }}`

            ### Usage
            ```bash
            # Deploy using the new chart version
            helm install my-app oci://ghcr.io/${{ env.REPO_OWNER_LC }}/charts/http-sample \
              --version ${{ steps.release.outputs.version }} \
              -f ./http-server/values.yaml
            ```

            ---
            🤖 *This PR was automatically created by the release workflow*
          branch: release/update-image-tags-${{ steps.release.outputs.version }}
          delete-branch: true
          labels: |
            automated
            release
            dependencies

      - name: Workflow Summary
        if: always()
        run: |
          echo "## 🚀 Chart Publication Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Release:** ${{ steps.release.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.release.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ **Status:** Chart published successfully" >> $GITHUB_STEP_SUMMARY
            echo "📦 **Chart:** \`oci://ghcr.io/${{ env.REPO_OWNER_LC }}/charts/http-sample:${{ steps.release.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Status:** Chart publication failed" >> $GITHUB_STEP_SUMMARY
          fi